\documentclass[10pt]{SPIIRAS_Proceedings}

\graphicspath{{media/}}

\usepackage{subfig}
\usepackage{tikz}
\usetikzlibrary{patterns,intersections}

\udk{000.00}

\titleRus{
  Новый алгоритм построения кратчайшего пути обхода
  конечного множества непересекающихся контуров на плоскости
}

\authorsRus{
  А.А. Петунин,
  Е.Г. Полищук,
  С.С. Уколов.
}

\authorsTitleRus{
  А.А. П\smallcapsfake{етунин},
  Е.Г. П\smallcapsfake{олищук},
  С.С. У\smallcapsfake{колов}
} % \smallcapfake необходим для имитации малых прописных букв ввиду отсутствия поддержки в используемом шрифте

\abstractRus{
  Рассматривается проблема маршрутизации режущего
  инструмента машин термической резки с ЧПУ
  когда точки врезки расположены
  на границах деталей,
  ограниченных отрезками прямых и дугами окружностей
  с использованием техники непрерывной резки
  (CCP),
  то есть каждый контур вырезается целиком.
  Общая задача минимизации длины маршрута
  в этом случае сводится к минимизации длины холостого хода.
  Показано, что она эквивалентна поиску
  кратчайшей ломаной с вершинами,
  расположенными на контурах.
  Представлен алгоритм построения
  такой ломаной для заданного порядка
  обхода контуров,
  доставляющий локальный минимум
  а также предложены достаточные условия
  глобального минимума.
  Предложен эвристический алгоритм
  маршрутизации на основе
  метода переменных окрестностей
  (VNS).
  Рассмотрены результаты численных экспериментов
  в сравнении с точным решением задачи GTSP.
}

\keywordsRus{
  задача резки,
  непрерывная резка,
  оптимизация,
  достаточные условия,
  эвристика,
  GTSP,
  метод переменных окрестностей
}

\begin{document}

\maketitle

\normalsize

\section*{Введение}
\label{sec:intro}

В процессе разработки управляющих программ
для машин термической резки листового материала с ЧПУ
возникает несколько оптимизационных задач.
Одна из них -- минимизация
длины холостого хода инструмента.
Она в некоторых случаях может быть сведена
к задаче поиска кратчайшей ломаной,
вершины которой расположены на заданных
плоских контурах,
являющихся границами деталей.
Расположение этих контуров на плоскости
в свою очередь получено решением другой
оптимизационной задачи -- <<раскроя>>.
Обе упомянутые задачи являются NP-полными.

Задача минимизации длины холостого хода инструмента
сама по себе является частным случаем
общей оптимизационной проблемы
маршрутизации инструмента.
Её полное решение в общем случае
не может быть получено
в разумное время
для задач типичных для современного
промышленного производства
(сотни / тысячи контуров),
поэтому на практике применяются разнообразные эвристики,
дающие решения приемлемого качества.

Для полного решения задачи маршрутизации
режущего инструмента для машин листовой резки
с ЧПУ
для минимизации времени или стоимости резки
требуется решить целый ряд задач.
Их описание и классификация приведены подробно в
\cite{bi01,bi02,bi03},
и схематически изображены на рис.~\ref{CP-classes}.

\begin{itemize}
  \item
  \textbf{Задача непрерывной резки}
  (Continuous Cutting Problem, CCP):
  каждый контур
  (ограничивающий одну из деталей)
  вырезается за один раз,
  одним движением инструмента,
  но резка может начаться в любой точке контура
  (и заканчивается в ней же)

  \item
  \textbf{Обобщённая задача коммивояжера}
  (Generalized Traveling Salesman Problem, GTSP):
  резка может начаться в одной из заранее
  заданных точек на контуре
  (количество таких точек конечно),
  после этого контур вырезается целиком

  \item
  \textbf{Задача резки с остановками}
  (Endpoint Cutting Problem, ECP):
  резка контура может начинаться только в
  заранее заданных точках на нём,
  но контур может вырезаться за несколько раз,
  частями

  \item
  \textbf{Сегментная задача непрерывной резки}
  (Segment Continuous Cutting Problem, SCCP):
  вводится понятие сегмента
  как обобщение понятия контура;
  сегмент может быть частью контура
  или объединением нескольких контуров
  и / или их частей.
  Каждый сегмент вырезается целиком,
  от начала до конца,
  таким образом
  $ CCP \subset SCCP$.

  \item
  \textbf{Обобщённая сегментная задача непрерывной резки}
  (Generalized Segment Continuous Cutting Problem, GSCCP):
  подобна сегментной задаче непрерывной резки
  (SCCP),
  но разбивка на сегменты не задана заранее
  и сама подлежит оптимизации

  \item
  \textbf{Задача прерывистой резки}
  (Intermittent Cutting Problem, ICP):
  наиболее общая формулировка задачи резки,
  встречающаяся в научной литературе,
  контуры могут вырезаться частями,
  в несколько подходов,
  начиная с произвольной точки.
\end{itemize}

\begin{figure}
  \centering
  \def\svgwidth{\columnwidth}
  \input{media/classes.pdf_tex}
  \caption{Классификация задач резки}
  \label{CP-classes}
\end{figure}

На практике задача оптимизации маршрута режущего инструмента
зачастую сводится к дискретной оптимизации
за счёт выбора конечного множества возможных точек врезки
на контурах деталей с некоторым заранее заданным шагом
$\varepsilon$,
то есть сводится к задаче ECP
\cite{bi04,bi05,bi06}
и её частному случаю ---
GTSP
\cite{bi07,bi08,bi09,bi10}.
Задача непрерывной резки CCP
тоже может сводиться к GTSP,
в этом случае суммарная ошибка длины
холостого хода оценивается как
$N \cdot \varepsilon$,
где $N$ -- количество контуров.
Для достижения точности результата
$\delta$,
таким образом необходимо выбирать малое
$\varepsilon \approx \delta / N$,
так что полное количество допустимых точек врезки растёт
(как $O (N)$)
и полный перебор требует экспоненциального времени.
Тем не менее, этот класс задач может успешно решаться,
например,
средствами динамического программирования
(DP)
а для небольших
$N \approx 30$ -- даже точно
(см. в частности \cite{bi15}).

В данной работе рассматриваются вопросы
поиска оптимального маршрута без
применения дискретизации
(то есть задача CCP),
которые слабо освещены в
открытых источниках,
см. например
\cite{bi11,bi12},
где описаны некоторые эвристики.

\subsection*{Технологические ограничения}

Тот факт, что полученный маршрут
должен быть физически выполнен
на конкретной машине термической резки с ЧПУ,
накладывает на последний определённые
технологические ограничения.

Так называемое <<ограничение предшествования>>
(наиболее подробно описанное в литературе),
вызвано тем,
что после вырезания замкнутого контура,
его содержимое более ничем не удерживается
и может свободно вращаться, сдвигаться и даже падать.
Поэтому внутренние контура деталей должны вырезаться до того,
как будет завершена резка содержащих их внешних контуров.
Аналогично и детали, размещённые в отверстиях
других деталей,
также должны вырезаться до завершения резки
содержащих их контуров.

Наконец, технология резки в большинстве случаев
диктует, что резак не может двигаться прямо по контуру детали,
но с некоторым сдвигом
(несколько миллиметров).
Этот сдвиг может вычисляться как в ходе
решения задачи маршрутизации,
так и после -- при генерации управляющей программы
на основе полученного маршрута или даже
непосредственно на станке в процессе резки.
Более того,
точки врезки
(в которых начинается резка)
как правило должны находиться
на ещё большем расстоянии от контуров деталей
во избежание повреждения последних.
В данной работе эти вопросы,
тем не менее,
не рассматриваются,
то есть строится маршрут,
проходящий в точности по контурам деталей,
и точки врезки
(а равно и точки окончания резки и выключения инструмента)
также ищутся прямо на контурах деталей.

\section{Задача непрерывной резки}

Рассмотрим Эвклидову плоскость
$\mathbb R ^ 2$
и на ней фигуру
$B$
(в большинстве практических случаев -- прямоугольник),
ограниченную замкнутым контуром.
Это -- модель листового материала,
подлежащего резке.
Пусть
$N$
попарно непересекающихся плоских контуров
$\{C_1, C_2, ... C_N\}$
расположены внутри
$B$,
ограничивая
$n$
деталей
$\{A_1, A_2 ... A_n\}$.
Деталь может быть ограничена
одним или несколькими контурами
(одним внешним и несколькими отверстиями),
так что в общем случае
$n \leqslant N$.

Контуры
$C_i$
могут быть произвольной формы,
но мы будем рассматривать только
состоящие из
(конечного числа)
отрезков прямых линий и дуг окружностей,
так как именно такие геометрические примитивы
поддерживаются программным обеспечением
современных машин термической резки с ЧПУ.
Частный случай,
когда контура состоят только
из отрезков прямых,
сводится к одному из вариантов
задачи обхода прямоугольников
(Touring Polygon Problem, TPP),
см.
\cite{bi13}.

Далее,
внутри
$B$
(как правило, на границе)
выберем две точки и обозначим их
$M_0$, $M_{N + 1}$
(почти всегда $M_0 = M_{N + 1}$),
которые будут использоваться
как начало и конец
маршрута резки.

Задача непрерывной резки
(Continuous Cutting Problem, CCP)
состоит в поиске:
\begin{enumerate}
\item
$N$ штук точек врезки $M_i \in C_i, i \in \overline{1, N}$
\item
Последовательности обхода контуров
$C_i$,
то есть перестановки
$N$
элементов
$I = (i_1, i_2, ... i_N)$
\end{enumerate}

Результатом решения задачи будет являться маршрут
\begin{equation}
  \{M_0, M_{i_1}, M_{i_2}, \dots M_{i_N}, M_{N + 1}\}
\end{equation}

Целевая функция в данном случае сильно упрощается
по сравнению с общей задачей маршрутизации резки
и сводится фактически к минимизации длины холостого хода:

\begin{equation}
  \mathcal{L} = \sum_{j=0}^N|M_{i_j}M_{i_{j+1}}|
  \label{air-move-length}
\end{equation}
$$
\mathcal{L} \to \min
$$
где, для простоты записи мы полагаем
$M_{i_0} = M_0$,
$M_{i_{N + 1}} = M_{N + 1}$.

Кроме того,
мы потребуем,
чтобы искомое решение задачи
удовлетворяло
описанному выше
ограничению предшествования.

Хотя контуры
$C_i$
по условию не пересекаются,
они могут быть вложены друг в друга:
\( \tilde C_a \subset \tilde C_b \),
где
$\tilde C_a$
обозначает 2-мерную фигуру,
ограниченную контуром
$C_a$
(в более традиционных обозначениях
$C_a = \partial \tilde C_a$).
В общей задаче маршрутизации
режущего инструмента это
соответствует двум разным случаям
(наличие отверстий в деталях с одной стороны
и размещение меньших деталей в отверстиях больших),
но в нашем случае оба этих
варианта обрабатываются одинаково.

Если один контур расположен внутри другого,
то внутренний должен быть вырезан
(посещён)
ранее, чем внешний:
\( \tilde C_a \subset \tilde C_b \Rightarrow i_a < i_b \),
в перестановке
$I = (i_1, i_2, ... i_N)$.
Таким образом,
множество допустимых перестановок ограничено.

\section{Алгоритм CCP-Relax решения задачи непрерывной резки}
\label{sec:ccp-relax}

Предлагаемый алгоритм решения задачи непрерывной резки
(см. \cite{berlin2019})
состоит из нескольких шагов,
что хорошо соответствует самой природе
решаемой задачи.

\subsection{Удаление <<внешних>> контуров}

Для автоматического соблюдения
ограничения предшествования,
мы начинаем с удаления всех контуров,
внутри которых есть вложенные контура,
так, чтобы остались только:
$$
\{C_i | \forall j \ne i: C_j \cap \tilde C_i = \varnothing \}
$$

В общем случае это приводит к уменьшению
(в некоторых случаях -- существенному)
сложности задачи
(с $N$ до некоторого $N'$),
что в свою очередь
сокращает время счёта
на втором и в особенности третьем
шагах алгоритма.

\subsection{Непрерывная оптимизация}

На этом этапе мы полагаем,
что последовательность обхода контуров
$I = (i_1, i_2, ... i_N)$
задана (фиксирована)
и ищем координаты точек врезки
$M_i \in C_i$
во все контура,
минимизируя полную длину холостого хода
(\ref{air-move-length}).
Для этого,
начальные позиции точек врезки выбираются
произвольным образом
(например, случайно)
и затем положение одной (каждой) из точек
$M_i$
изменяется, а все остальные остаются неподвижны:
$\mathcal{L}(M_i) \to \min$.
Большинство слагаемых в целевой функции
(\ref{air-move-length})
при этом постоянны,
так что сама функция упрощается до
$$
|M_{i-1}M_i|+|M_iM_{i+1}| \to \min_{M_i \in C_i}
$$

Несложный геометрический анализ показывает,
что если точки
$M_{i-1}$
и
$M_{i + 1}$
расположены по разные стороны сегмента контура
$C_i$,
то оптимальное положение точки врезки
$M_i$
оказывается на пересечении с этим сегментом:
$M_i = M_{i-1} M_{i + 1} \cap C_i$
(если, конечно,
такое пересечение существует;
в противном случае
решением будет один из концов сегмента),
см. рис. \ref{pierce-thru}.

Если же точки располагаются
с одной стороны сегмента,
решение легко находится при помощи
{\it принципа Ферма},
или другими словами правила
<<угол падения равен углу отражения>>
(или опять на одном из концов сегмента),
см. рис. \ref{pierce-fermat}.

\begin{figure}
  \centering
  \subfloat[На пересечении звена ломаной]{
    \label{pierce-thru}
    \tikz[rotate=-12,scale=0.68]{
        \draw[thick,name path=C1]
            (0,5) node[above] {$C_{i-1}$}
            to[bend right] (1,0);
        \draw[thick,name path=C2]
            (3,0) node[below] {$C_i$}
            to[bend right] (3,2);
        \draw[thick,name path=C3]
            (4,3) node[above] {$C_{i+1}$}
            to[bend right] (5,0);
        \path[name path=L0]
            (0,1.5) -- (6,2);
        \path[name path=Lx]
            (0,1) -- (6,1);
        \fill[name intersections={of=C1 and Lx, name=X}]
            (X-1) coordinate(M1) circle(3pt) node[below] {$M_{i-1}$};
        \fill[name intersections={of=C2 and L0, name=X}]
            (X-1) coordinate(M2) circle(3pt) node[below left]{$M_i$};
        \draw[name intersections={of=C2 and Lx, name=X}]
            (X-1) coordinate(M2x) node[below right]{$M'_i$};
        \fill[name intersections={of=C3 and Lx, name=X}]
            (X-1) coordinate(M3) circle(3pt) node[right] {$M_{i+1}$};
        \draw[dashed]
            (M1) -- (M3);
        \draw[thin,-latex]
            (M2)
            to[bend right] (M2x);
    }
  }
  \subfloat[С использованием \textit{принципа Ферма}]{
    \label{pierce-fermat}
    \tikz[rotate=-12,scale=0.68]{
      \draw[thick]
          (0, 0) coordinate(zero) -- (5, 0) coordinate(future) node[right] {$C_i$};
      \fill[black]
          (1.5, 0) circle(3pt) coordinate(middle) node[below left]  {$M_i$}
          (1, 1) circle(3pt) coordinate(from) node[above right] {$M_{i-1}$} ++(-1.5,0) node[above] {$C_{i-1}$}
          (4.5, 2) circle(3pt) coordinate(to) node[above right] {$M_{i+1}$} ++(1.5,0) node[below] {$C_{i+1}$};
      \begin{scope}
          \clip (from) circle(1);
          \draw[thick] (from) ++(0, 3) circle(3);
      \end{scope};
      \begin{scope}
          \clip (to) circle(1.5);
          \draw[thick] (to) ++(3, 4) circle(5);
      \end{scope};
      % \draw[dashed] (from) -- (middle) -- (to);
      \draw[thin] (4.5, -2) circle(0.062) coordinate(mirror) node[right] {$\hat M_{i+1}$};
      \coordinate (opt) at (intersection of zero--future and mirror--from);
      % \draw[thin] (opt) circle(3pt);
      \draw[dotted]
          (mirror) -- (opt)
          (mirror) -- (to);
      \draw[dashed] (from) -- (opt) -- (to);

      \draw[thin,-latex] (middle) to[bend right] (opt) node[below] {$M'_i$};
    }
  }
  \caption{Оптимальное положение точки врезки}
  \label{shift-pierce-point}
\end{figure}

Общая схема этого шага оптимизации может быть записана таким образом:
\begin{enumerate}
  \item
  Выбираем произвольные начальные позиции точек врезки
  $M_i \in C_i, \forall i$.
  \item
  $\forall i \in \overline{1,N}$
  находим оптимальное положение
  $M_i$
  как описано выше за константное время
  \item
  Повторяем предыдущий шаг,
  до тех пор,
  пока длина холостого пути
  (\ref{air-move-length})
  не сойдётся
  (с некоторой наперёд заданной точностью $\delta$)
\end{enumerate}

На практике весь процесс хорошо сходится
за время
$O(N)$
и поэтому многократно применяется
в качестве подпрограммы на следующем шаге.

\subsection{Дискретная оптимизация}


\end{document}
